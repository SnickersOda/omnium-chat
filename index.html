<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Omnium OS</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        :root { --bg: #020617; --sidebar: #0a0f1e; --accent: #2563eb; --glow: #00d2ff; --online: #10b981; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; height: 100vh; background: var(--bg); font-family: 'Segoe UI', sans-serif; color: white; overflow: hidden; display: flex; }
        
        /* Старый широкий интерфейс */
        .sidebar { width: 280px; background: var(--sidebar); display: flex; flex-direction: column; border-right: 1px solid #1e293b; }
        .profile-section { padding: 20px; border-bottom: 1px solid #1e293b; text-align: center; }
        .avatar-main { width: 65px; height: 65px; border-radius: 20px; border: 2px solid var(--glow); object-fit: cover; cursor: pointer; }
        
        .room-item { padding: 12px 15px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .room-item.active { background: rgba(37, 99, 235, 0.2); border-left: 4px solid var(--accent); }
        .status-dot { width: 10px; height: 10px; background: var(--online); border-radius: 50%; border: 2px solid var(--sidebar); position: absolute; bottom: 0; right: 0; }

        .main { flex: 1; display: flex; flex-direction: column; background: rgba(15, 23, 42, 0.98); }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; scrollbar-width: none; }
        
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 15px; position: relative; animation: slideUp 0.2s ease; }
        .me { align-self: flex-end; background: var(--accent); border-bottom-right-radius: 2px; }
        .friend { align-self: flex-start; background: #1e293b; border-bottom-left-radius: 2px; }
        
        /* Ник над сообщением */
        .msg-author { font-size: 10px; font-weight: bold; margin-bottom: 4px; color: var(--glow); opacity: 0.8; }
        .msg-time { font-size: 9px; margin-top: 4px; text-align: right; opacity: 0.5; }

        .input-area { padding: 15px; background: var(--sidebar); display: flex; gap: 10px; align-items: center; }
        input { flex: 1; background: #1e293b; border: 1px solid #334155; padding: 12px 18px; border-radius: 25px; color: white; outline: none; }
        .btn { background: var(--accent); border: none; padding: 10px 20px; border-radius: 20px; color: white; cursor: pointer; font-weight: bold; }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="profile-section">
        <label style="position: relative; display: inline-block;">
            <img id="myAva" class="avatar-main" src="">
            <div class="status-dot"></div>
            <input type="file" id="avaPicker" style="display:none" accept="image/*">
        </label>
        <div id="myNickDisplay" style="margin-top:10px; font-weight:bold; color:var(--glow); cursor:pointer;" onclick="changeNick()">@loading...</div>
        <div style="font-size: 10px; opacity: 0.5;">Нажми на аву, чтобы сменить</div>
    </div>
    <div style="padding: 10px;"><button onclick="addChat()" class="btn" style="width:100%">+ Найти друга</button></div>
    <div id="rooms" style="overflow-y:auto; flex:1"></div>
</div>

<div class="main">
    <div id="messages"></div>
    <div class="input-area">
        <input type="text" id="mInp" placeholder="Напиши сообщение...">
        <button id="sBtn" class="btn">➤</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, set, onValue, off, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDP-21yabgFIBC6IwSYFeS-oTJcXG_6-BM",
        authDomain: "omniumchat.firebaseapp.com",
        databaseURL: "https://omniumchat-default-rtdb.firebaseio.com",
        projectId: "omniumchat",
        storageBucket: "omniumchat.firebasestorage.app",
        messagingSenderId: "609039824401",
        appId: "1:609039824401:web:78aa1222ea7418bec823b0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const getBotAva = (n) => `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${n}`;

    let myNick = localStorage.getItem('chatNick') || prompt("Ник:") || 'user'+Math.floor(Math.random()*999);
    myNick = myNick.toLowerCase().trim().replace(/[^a-z0-9]/g, '');
    localStorage.setItem('chatNick', myNick);
    
    document.getElementById('myNickDisplay').innerText = "@" + myNick;

    // Смена аватарки (как просил)
    let myAva = localStorage.getItem('myCustomAva') || getBotAva(myNick);
    document.getElementById('myAva').src = myAva;

    document.getElementById('avaPicker').onchange = e => {
        const reader = new FileReader();
        reader.onload = ev => {
            myAva = ev.target.result;
            localStorage.setItem('myCustomAva', myAva);
            document.getElementById('myAva').src = myAva;
            set(ref(db, `users/${myNick}/ava`), myAva);
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    window.changeNick = () => {
        const n = prompt("Новый ник:", myNick);
        if(n && n.toLowerCase().trim() !== myNick) {
            localStorage.setItem('chatNick', n.toLowerCase().trim().replace(/[^a-z0-9]/g, ''));
            location.reload();
        }
    };

    // Статус в сети
    set(ref(db, `status/${myNick}`), 'online');
    onDisconnect(ref(db, `status/${myNick}`)).set('offline');

    let activeRoom = null;

    // Отправка на Enter
    const send = () => {
        const inp = document.getElementById('mInp');
        if(activeRoom && inp.value.trim()) {
            push(ref(db, `messages/${activeRoom}`), { from: myNick, text: inp.value.trim(), time: serverTimestamp() });
            inp.value = '';
        }
    };

    document.getElementById('sBtn').onclick = send;
    document.getElementById('mInp').onkeydown = e => { if(e.key === 'Enter') send(); };

    window.addChat = () => {
        const f = prompt("Ник друга:"); if(!f) return;
        const friend = f.toLowerCase().trim();
        const rid = ['chat', myNick, friend].sort().join('_');
        set(ref(db, `rooms/${rid}/members/${myNick}`), true);
        set(ref(db, `rooms/${rid}/members/${friend}`), true);
        set(ref(db, `users/${myNick}/ava`), myAva); // Чтобы друг видел твою аву
        openRoom(rid);
    };

    function openRoom(id) {
        activeRoom = id;
        document.getElementById('messages').innerHTML = '';
        off(ref(db, `messages/${id}`));
        onChildAdded(ref(db, `messages/${id}`), s => {
            const m = s.val();
            const time = m.time ? new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
            const d = document.createElement('div');
            d.className = `msg ${m.from === myNick ? 'me' : 'friend'}`;
            // Добавляем ник собеседника над его сообщением
            d.innerHTML = `
                ${m.from !== myNick ? `<div class="msg-author">${m.from}</div>` : ''}
                <div>${m.text}</div>
                <div class="msg-time">${time}</div>
            `;
            document.getElementById('messages').appendChild(d);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        });
    }

    onValue(ref(db, 'rooms'), snap => {
        const rDiv = document.getElementById('rooms'); rDiv.innerHTML = '';
        snap.forEach(c => {
            if(c.val().members && c.val().members[myNick]) {
                const friendNick = c.key.split('_').filter(n => n !== myNick && n !== 'chat')[0] || 'Чат';
                const item = document.createElement('div');
                item.className = `room-item ${activeRoom === c.key ? 'active' : ''}`;
                
                onValue(ref(db, `users/${friendNick}/ava`), avSnap => {
                    const ava = avSnap.val() || getBotAva(friendNick);
                    onValue(ref(db, `status/${friendNick}`), st => {
                        const isOn = st.val() === 'online';
                        item.innerHTML = `
                            <div style="position:relative"><img src="${ava}" style="width:40px;height:40px;border-radius:12px;object-fit:cover;">
                            ${isOn ? '<div class="status-dot"></div>' : ''}</div>
                            <div><div style="font-weight:bold;font-size:14px">${friendNick}</div>
                            <div style="font-size:11px;color:${isOn?'#10b981':'#64748b'}">${isOn?'в сети':'был недавно'}</div></div>
                        `;
                    });
                });
                item.onclick = () => openRoom(c.key);
                rDiv.appendChild(item);
            }
        });
    });
</script>
</body>
</html>
