<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Omnium OS 10.0</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        :root { --bg: #020617; --sidebar: #0a0f1e; --accent: #2563eb; --glow: #00d2ff; --online: #10b981; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; height: 100vh; background: var(--bg); font-family: 'Segoe UI', sans-serif; color: white; overflow: hidden; display: flex; }
        
        /* –°–ª–∞–π–¥–±–∞—Ä —Å –Ω–∏–∫–∞–º–∏ */
        .sidebar { width: 260px; background: var(--sidebar); display: flex; flex-direction: column; border-right: 1px solid #1e293b; transition: 0.3s; }
        .profile-section { padding: 20px; border-bottom: 1px solid #1e293b; text-align: center; }
        .my-ava-wrapper { position: relative; display: inline-block; cursor: pointer; }
        .avatar { width: 60px; height: 60px; border-radius: 20px; border: 2px solid var(--glow); object-fit: cover; }
        .status-badge { width: 12px; height: 12px; background: var(--online); border-radius: 50%; position: absolute; bottom: 0; right: 0; border: 2px solid var(--sidebar); box-shadow: 0 0 10px var(--online); }

        .room-item { padding: 12px 15px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .room-item:hover { background: rgba(255,255,255,0.05); }
        .room-item.active { background: rgba(37, 99, 235, 0.2); border-left: 4px solid var(--accent); }
        .room-info { flex: 1; overflow: hidden; }
        .room-name { font-weight: bold; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .room-status { font-size: 11px; color: var(--online); opacity: 0.8; }

        /* –ß–∞—Ç */
        .main { flex: 1; display: flex; flex-direction: column; background: rgba(15, 23, 42, 0.98); }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; scrollbar-width: none; }
        
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 15px; position: relative; animation: slideUp 0.2s ease; }
        .me { align-self: flex-end; background: var(--accent); border-bottom-right-radius: 2px; }
        .friend { align-self: flex-start; background: #1e293b; border-bottom-left-radius: 2px; }
        
        .msg-meta { font-size: 10px; opacity: 0.6; display: flex; justify-content: space-between; gap: 10px; margin-bottom: 3px; }
        .msg-time { font-size: 9px; margin-top: 4px; text-align: right; opacity: 0.5; }
        .chat-img { max-width: 100%; border-radius: 10px; margin-top: 5px; }

        .input-area { padding: 15px; background: var(--sidebar); display: flex; gap: 10px; align-items: center; }
        input { flex: 1; background: #1e293b; border: 1px solid #334155; padding: 12px 18px; border-radius: 25px; color: white; outline: none; }
        .btn { background: var(--accent); border: none; padding: 10px 20px; border-radius: 20px; color: white; cursor: pointer; font-weight: bold; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
        @media (max-width: 600px) { .sidebar { width: 80px; } .room-info, .profile-section span { display: none; } }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="profile-section">
        <label class="my-ava-wrapper">
            <img id="myAva" class="avatar" src="">
            <div class="status-badge"></div>
            <input type="file" id="avaPicker" style="display:none" accept="image/*">
        </label>
        <div id="myNickDisplay" style="margin-top:10px; font-weight:bold; font-size:14px; color:var(--glow)">...</div>
    </div>
    <div style="padding: 10px;"><button onclick="addChat()" style="width:100%;" class="btn">+ –ß–∞—Ç</button></div>
    <div id="rooms" style="overflow-y:auto; flex:1"></div>
</div>

<div class="main">
    <div id="messages"></div>
    <div id="pBox" style="display:none; padding:10px; background:#1e293b;"><img id="pImg" style="height:80px; border-radius:10px;"></div>
    <div class="input-area">
        <label style="font-size:20px; cursor:pointer">üñºÔ∏è<input type="file" id="fInp" style="display:none" accept="image/*"></label>
        <input type="text" id="mInp" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="sBtn" class="btn">‚û§</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, set, onValue, off, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDP-21yabgFIBC6IwSYFeS-oTJcXG_6-BM",
        authDomain: "omniumchat.firebaseapp.com",
        databaseURL: "https://omniumchat-default-rtdb.firebaseio.com",
        projectId: "omniumchat",
        storageBucket: "omniumchat.firebasestorage.app",
        messagingSenderId: "609039824401",
        appId: "1:609039824401:web:78aa1222ea7418bec823b0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const getBotAva = (n) => `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${n}`;

    let myNick = localStorage.getItem('chatNick') || prompt("–ù–∏–∫:") || 'user'+Math.floor(Math.random()*999);
    myNick = myNick.toLowerCase().trim();
    localStorage.setItem('chatNick', myNick);
    document.getElementById('myNickDisplay').innerText = "@" + myNick;

    // –ö–∞—Å—Ç–æ–º–Ω–∞—è –∞–≤–∞—Ç–∞—Ä–∫–∞
    let myCustomAva = localStorage.getItem('myCustomAva') || getBotAva(myNick);
    document.getElementById('myAva').src = myCustomAva;

    document.getElementById('avaPicker').onchange = e => {
        const reader = new FileReader();
        reader.onload = ev => {
            myCustomAva = ev.target.result;
            localStorage.setItem('myCustomAva', myCustomAva);
            document.getElementById('myAva').src = myCustomAva;
            set(ref(db, `users/${myNick}/ava`), myCustomAva);
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    // –°—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω
    const myStatusRef = ref(db, `status/${myNick}`);
    set(myStatusRef, 'online');
    onDisconnect(myStatusRef).set('offline');

    let activeRoom = null, pendingImg = null;

    // –†–∞–±–æ—Ç–∞ —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
    function openRoom(id, name) {
        activeRoom = id;
        const mDiv = document.getElementById('messages');
        mDiv.innerHTML = '';
        off(ref(db, `messages/${id}`));
        onChildAdded(ref(db, `messages/${id}`), s => {
            const m = s.val();
            const time = m.time ? new Date(m.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--';
            const d = document.createElement('div');
            d.className = `msg ${m.from === myNick ? 'me' : 'friend'}`;
            d.innerHTML = `
                <div class="msg-meta"><span>${m.from}</span></div>
                ${m.img ? `<img src="${m.img}" class="chat-img">` : ''}
                <div>${m.text || ''}</div>
                <div class="msg-time">${time}</div>
            `;
            mDiv.appendChild(d);
            mDiv.scrollTop = mDiv.scrollHeight;
        });
    }

    // –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ —Å –Ω–∏–∫–∞–º–∏ –∏ —Å—Ç–∞—Ç—É—Å–æ–º
    onValue(ref(db, 'rooms'), snap => {
        const rDiv = document.getElementById('rooms'); rDiv.innerHTML = '';
        snap.forEach(c => {
            if(c.val().members[myNick]) {
                const friendNick = c.key.replace('chat_','').replace(myNick,'').replace('_','');
                const item = document.createElement('div');
                item.className = `room-item ${activeRoom === c.key ? 'active' : ''}`;
                
                // –°–ª—É—à–∞–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É –∏ —Å—Ç–∞—Ç—É—Å –¥—Ä—É–≥–∞
                onValue(ref(db, `users/${friendNick}/ava`), s => {
                    const ava = s.val() || getBotAva(friendNick);
                    onValue(ref(db, `status/${friendNick}`), st => {
                        const isOnline = st.val() === 'online';
                        item.innerHTML = `
                            <div style="position:relative">
                                <img src="${ava}" style="width:40px; height:40px; border-radius:12px; object-fit:cover;">
                                ${isOnline ? '<div class="status-badge" style="width:8px; height:8px; border:1px solid #0a0f1e"></div>' : ''}
                            </div>
                            <div class="room-info">
                                <div class="room-name">${friendNick}</div>
                                <div class="room-status" style="color:${isOnline ? '#10b981' : '#64748b'}">${isOnline ? '–≤ —Å–µ—Ç–∏' : '–±—ã–ª –Ω–µ–¥–∞–≤–Ω–æ'}</div>
                            </div>
                        `;
                    });
                });
                item.onclick = () => openRoom(c.key, friendNick);
                rDiv.appendChild(item);
            }
        });
    });

    window.addChat = () => {
        const f = prompt("–ù–∏–∫ –¥—Ä—É–≥–∞:"); if(!f) return;
        const rid = ['chat', myNick, f.toLowerCase().trim()].sort().join('_');
        set(ref(db, `rooms/${rid}`), { members: {[myNick]:true, [f.toLowerCase().trim()]:true} });
        set(ref(db, `users/${myNick}/ava`), myCustomAva); // –ß—Ç–æ–±—ã –¥—Ä—É–≥ –≤–∏–¥–µ–ª —Ç–≤–æ—é –∞–≤—É
        openRoom(rid, f);
    };

    document.getElementById('fInp').onchange = e => {
        const reader = new FileReader();
        reader.onload = ev => { pendingImg = ev.target.result; document.getElementById('pImg').src=pendingImg; document.getElementById('pBox').style.display='block'; };
        reader.readAsDataURL(e.target.files[0]);
    };

    document.getElementById('sBtn').onclick = () => {
        const inp = document.getElementById('mInp');
        if(activeRoom && (inp.value.trim() || pendingImg)) {
            push(ref(db, `messages/${activeRoom}`), { from: myNick, text: inp.value.trim(), img: pendingImg, time: serverTimestamp() });
            inp.value = ''; pendingImg = null; document.getElementById('pBox').style.display='none';
        }
    };
</script>
</body>
</html>
