<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Omnium OS</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        :root { --bg: #020617; --sidebar: #0a0f1e; --accent: #2563eb; --glow: #00d2ff; --online: #10b981; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; height: 100vh; background: var(--bg); font-family: 'Segoe UI', sans-serif; color: white; overflow: hidden; display: flex; }
        
        /* –®–∏—Ä–æ–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏–∑ image_7af50e */
        .sidebar { width: 300px; background: var(--sidebar); display: flex; flex-direction: column; border-right: 1px solid #1e293b; }
        .profile-section { padding: 25px 20px; border-bottom: 1px solid #1e293b; text-align: center; }
        .avatar-main { width: 70px; height: 70px; border-radius: 22px; border: 2px solid var(--glow); object-fit: cover; cursor: pointer; transition: 0.2s; }
        
        .room-item { padding: 15px; display: flex; align-items: center; gap: 15px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.03); transition: 0.2s; }
        .room-item.active { background: rgba(37, 99, 235, 0.15); border-left: 4px solid var(--accent); }
        .status-dot { width: 12px; height: 12px; background: var(--online); border-radius: 50%; border: 2px solid var(--sidebar); position: absolute; bottom: 0; right: 0; }

        .main { flex: 1; display: flex; flex-direction: column; background: rgba(15, 23, 42, 0.98); }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scrollbar-width: none; }
        
        .msg { max-width: 75%; padding: 10px 15px; border-radius: 18px; position: relative; animation: slideUp 0.2s ease; line-height: 1.4; }
        .me { align-self: flex-end; background: var(--accent); border-bottom-right-radius: 4px; }
        .friend { align-self: flex-start; background: #1e293b; border-bottom-left-radius: 4px; }
        
        /* –ù–∏–∫ –Ω–∞–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ–º */
        .msg-author { font-size: 11px; font-weight: 800; margin-bottom: 4px; color: var(--glow); text-transform: lowercase; }
        .msg-time { font-size: 9px; margin-top: 5px; text-align: right; opacity: 0.5; }

        .input-area { padding: 20px; background: var(--sidebar); display: flex; gap: 12px; align-items: center; border-top: 1px solid #1e293b; }
        input { flex: 1; background: #1e293b; border: 1px solid #334155; padding: 14px 20px; border-radius: 30px; color: white; outline: none; font-size: 15px; }
        .btn { background: var(--accent); border: none; padding: 12px 25px; border-radius: 25px; color: white; cursor: pointer; font-weight: bold; }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="profile-section">
        <label style="position: relative; display: inline-block;">
            <img id="myAva" class="avatar-main" src="">
            <div class="status-dot"></div>
            <input type="file" id="avaPicker" style="display:none" accept="image/*">
        </label>
        <div id="myNickDisplay" style="margin-top:12px; font-weight:bold; color:var(--glow); cursor:pointer; font-size: 16px;" onclick="changeNick()">@...</div>
    </div>
    <div style="padding: 15px;"><button onclick="addChat()" class="btn" style="width:100%">+ –ù–∞–π—Ç–∏ –¥—Ä—É–≥–∞</button></div>
    <div id="rooms" style="overflow-y:auto; flex:1"></div>
</div>

<div class="main">
    <div id="messages"></div>
    <div class="input-area">
        <label style="cursor:pointer; font-size: 20px;">üñºÔ∏è<input type="file" id="fInp" style="display:none" accept="image/*"></label>
        <input type="text" id="mInp" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="sBtn" class="btn">‚û§</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, set, onValue, off, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDP-21yabgFIBC6IwSYFeS-oTJcXG_6-BM",
        authDomain: "omniumchat.firebaseapp.com",
        databaseURL: "https://omniumchat-default-rtdb.firebaseio.com",
        projectId: "omniumchat",
        storageBucket: "omniumchat.firebasestorage.app",
        messagingSenderId: "609039824401",
        appId: "1:609039824401:web:78aa1222ea7418bec823b0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const getBotAva = (n) => `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${n}`;

    let myNick = localStorage.getItem('chatNick') || prompt("–¢–≤–æ–π –Ω–∏–∫:") || 'user'+Math.floor(Math.random()*999);
    myNick = myNick.toLowerCase().trim().replace(/[^a-z–∞-—è0-9]/g, '');
    localStorage.setItem('chatNick', myNick);
    document.getElementById('myNickDisplay').innerText = "@" + myNick;

    let myAva = localStorage.getItem('myCustomAva') || getBotAva(myNick);
    document.getElementById('myAva').src = myAva;

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤—ã –≤ Firebase, —á—Ç–æ–±—ã –¥—Ä—É–≥–∏–µ –≤–∏–¥–µ–ª–∏
    const updateAva = (base64) => {
        set(ref(db, `users/${myNick}/ava`), base64);
        localStorage.setItem('myCustomAva', base64);
    };

    document.getElementById('avaPicker').onchange = e => {
        const reader = new FileReader();
        reader.onload = ev => {
            document.getElementById('myAva').src = ev.target.result;
            updateAva(ev.target.result);
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    window.changeNick = () => {
        const n = prompt("–ù–æ–≤—ã–π –Ω–∏–∫:", myNick);
        if(n && n.toLowerCase().trim() !== myNick) {
            localStorage.setItem('chatNick', n.toLowerCase().trim().replace(/[^a-z–∞-—è0-9]/g, ''));
            location.reload();
        }
    };

    // –°—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω
    set(ref(db, `status/${myNick}`), 'online');
    onDisconnect(ref(db, `status/${myNick}`)).set('offline');

    let activeRoom = null;

    const send = (img = null) => {
        const inp = document.getElementById('mInp');
        if(activeRoom && (inp.value.trim() || img)) {
            push(ref(db, `messages/${activeRoom}`), { 
                from: myNick, 
                text: inp.value.trim(), 
                img: img,
                time: serverTimestamp() 
            });
            inp.value = '';
        }
    };

    document.getElementById('sBtn').onclick = () => send();
    document.getElementById('mInp').onkeydown = e => { if(e.key === 'Enter') send(); };
    document.getElementById('fInp').onchange = e => {
        const reader = new FileReader();
        reader.onload = ev => send(ev.target.result);
        reader.readAsDataURL(e.target.files[0]);
    };

    window.addChat = () => {
        const f = prompt("–ù–∏–∫ –¥—Ä—É–≥–∞:"); if(!f) return;
        const friend = f.toLowerCase().trim().replace(/[^a-z–∞-—è0-9]/g, '');
        const rid = ['chat', myNick, friend].sort().join('_');
        set(ref(db, `rooms/${rid}/members/${myNick}`), true);
        set(ref(db, `rooms/${rid}/members/${friend}`), true);
        set(ref(db, `users/${myNick}/ava`), myAva); 
        openRoom(rid);
    };

    function openRoom(id) {
        activeRoom = id;
        document.getElementById('messages').innerHTML = '';
        off(ref(db, `messages/${id}`));
        onChildAdded(ref(db, `messages/${id}`), s => {
            const m = s.val();
            const time = m.time ? new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
            const d = document.createElement('div');
            d.className = `msg ${m.from === myNick ? 'me' : 'friend'}`;
            d.innerHTML = `
                ${m.from !== myNick ? `<div class="msg-author">${m.from}</div>` : ''}
                ${m.img ? `<img src="${m.img}" style="max-width:100%; border-radius:10px; margin-bottom:5px;">` : ''}
                <div>${m.text || ''}</div>
                <div class="msg-time">${time}</div>
            `;
            document.getElementById('messages').appendChild(d);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        });
    }

    onValue(ref(db, 'rooms'), snap => {
        const rDiv = document.getElementById('rooms'); rDiv.innerHTML = '';
        snap.forEach(c => {
            if(c.val().members && c.val().members[myNick]) {
                // –ü—Ä—è–º–∞—è –ª–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∏–∫–∞ –¥—Ä—É–≥–∞ –±–µ–∑ "priv"
                const keys = c.key.split('_');
                const friendNick = keys.find(k => k !== myNick && k !== 'chat') || '–ß–∞—Ç';
                
                const item = document.createElement('div');
                item.className = `room-item ${activeRoom === c.key ? 'active' : ''}`;
                
                onValue(ref(db, `users/${friendNick}/ava`), avSnap => {
                    const ava = avSnap.val() || getBotAva(friendNick);
                    onValue(ref(db, `status/${friendNick}`), st => {
                        const isOn = st.val() === 'online';
                        item.innerHTML = `
                            <div style="position:relative"><img src="${ava}" style="width:45px;height:45px;border-radius:15px;object-fit:cover;">
                            ${isOn ? '<div class="status-dot"></div>' : ''}</div>
                            <div>
                                <div class="room-name">${friendNick}</div>
                                <div class="room-status" style="color:${isOn?'#10b981':'#64748b'}">${isOn?'–≤ —Å–µ—Ç–∏':'–±—ã–ª –Ω–µ–¥–∞–≤–Ω–æ'}</div>
                            </div>
                        `;
                    });
                });
                item.onclick = () => openRoom(c.key);
                rDiv.appendChild(item);
            }
        });
    });
</script>
</body>
</html>
