<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Omnium OS</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#020617">
    <link rel="icon" href="https://api.dicebear.com/7.x/bottts-neutral/svg?seed=Omnium">

    <style>
        :root { --bg: #020617; --glass: rgba(15, 23, 42, 0.98); --accent: #2563eb; --glow: #00d2ff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; height: 100vh; background: var(--bg); font-family: 'Segoe UI', sans-serif; color: white; overflow: hidden; display: flex; }
        
        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å (Sidebar) */
        .sidebar { width: 80px; background: #0a0f1e; display: flex; flex-direction: column; align-items: center; padding: 15px 0; border-right: 1px solid #1e293b; }
        .main { flex: 1; display: flex; flex-direction: column; background: var(--glass); position: relative; }
        
        .avatar { width: 50px; height: 50px; border-radius: 15px; border: 2px solid var(--glow); margin-bottom: 20px; cursor: pointer; object-fit: cover; }
        .room-icon { width: 45px; height: 45px; border-radius: 50%; background: #1e293b; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid transparent; transition: 0.2s; overflow: hidden; }
        .room-icon:hover { border-color: var(--glow); }
        .room-icon img { width: 100%; height: 100%; object-fit: cover; }

        /* –û–∫–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π */
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; scrollbar-width: none; }
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 15px; line-height: 1.4; animation: fadeIn 0.3s ease; position: relative; }
        .me { align-self: flex-end; background: var(--accent); border-bottom-right-radius: 2px; }
        .friend { align-self: flex-start; background: #1e293b; border-bottom-left-radius: 2px; }
        
        .sender-name { font-size: 10px; font-weight: bold; margin-bottom: 4px; opacity: 0.7; color: var(--glow); }
        .chat-img { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; }

        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
        .input-area { padding: 15px; background: #0a0f1e; display: flex; gap: 10px; align-items: center; }
        input { flex: 1; background: #1e293b; border: 1px solid #334155; padding: 12px 15px; border-radius: 20px; color: white; outline: none; }
        .btn-action { background: var(--accent); border: none; width: 45px; height: 45px; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        
        #preview-box { display: none; position: absolute; bottom: 80px; left: 20px; background: #1e293b; padding: 10px; border-radius: 15px; border: 1px solid var(--glow); }
        #preview-img { max-height: 100px; border-radius: 8px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="sidebar">
    <img id="myAva" class="avatar" src="" onclick="changeNick()" title="–°–º–µ–Ω–∏—Ç—å –Ω–∏–∫">
    <div onclick="addChat()" class="room-icon" style="background: var(--accent);">‚ûï</div>
    <div id="rooms"></div>
</div>

<div class="main">
    <div id="messages"></div>
    
    <div id="preview-box">
        <img id="preview-img" src="">
        <div onclick="cancelImg()" style="color: red; cursor: pointer; text-align: center; font-size: 12px; margin-top: 5px;">–û—Ç–º–µ–Ω–∞</div>
    </div>

    <div class="input-area">
        <label style="cursor: pointer; font-size: 20px;">üñºÔ∏è<input type="file" id="fInp" style="display:none" accept="image/*"></label>
        <input type="text" id="mInp" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="sBtn" class="btn-action">‚û§</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, set, onValue, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDP-21yabgFIBC6IwSYFeS-oTJcXG_6-BM",
        authDomain: "omniumchat.firebaseapp.com",
        databaseURL: "https://omniumchat-default-rtdb.firebaseio.com",
        projectId: "omniumchat",
        storageBucket: "omniumchat.firebasestorage.app",
        messagingSenderId: "609039824401",
        appId: "1:609039824401:web:78aa1222ea7418bec823b0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const getAva = (n) => `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${n}`;

    let myNick = localStorage.getItem('chatNick') || prompt("–¢–≤–æ–π –Ω–∏–∫:") || 'user' + Math.floor(Math.random()*1000);
    myNick = myNick.toLowerCase().trim().replace(/\s/g, '_');
    localStorage.setItem('chatNick', myNick);

    document.getElementById('myAva').src = getAva(myNick);

    window.changeNick = () => {
        const n = prompt("–ù–æ–≤—ã–π –Ω–∏–∫:", myNick);
        if(n && n !== myNick) { localStorage.setItem('chatNick', n.toLowerCase().trim()); location.reload(); }
    };

    let activeRoom = null;
    let pendingImg = null;

    // –†–∞–±–æ—Ç–∞ —Å —Ñ–æ—Ç–æ
    document.getElementById('fInp').onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = ev => {
            pendingImg = ev.target.result;
            document.getElementById('preview-img').src = pendingImg;
            document.getElementById('preview-box').style.display = 'block';
        };
        reader.readAsDataURL(file);
    };

    window.cancelImg = () => { pendingImg = null; document.getElementById('preview-box').style.display = 'none'; };

    // –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞
    window.addChat = () => {
        const friend = prompt("–ù–∏–∫ –¥—Ä—É–≥–∞:");
        if(!friend) return;
        const rid = ['chat', myNick, friend.toLowerCase().trim()].sort().join('_');
        set(ref(db, `rooms/${rid}`), { members: {[myNick]:true, [friend.toLowerCase().trim()]:true}, name: friend });
        openRoom(rid);
    };

    function openRoom(id) {
        activeRoom = id;
        const mDiv = document.getElementById('messages');
        mDiv.innerHTML = '';
        off(ref(db, `messages/${id}`));
        onChildAdded(ref(db, `messages/${id}`), s => {
            const m = s.val();
            const d = document.createElement('div');
            d.className = `msg ${m.from === myNick ? 'me' : 'friend'}`;
            d.innerHTML = `
                <div class="sender-name">${m.from}</div>
                ${m.img ? `<img src="${m.img}" class="chat-img">` : ''}
                <div>${m.text || ''}</div>
            `;
            mDiv.appendChild(d);
            mDiv.scrollTop = mDiv.scrollHeight;
        });
    }

    // –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
    onValue(ref(db, 'rooms'), snap => {
        const rDiv = document.getElementById('rooms'); rDiv.innerHTML = '';
        snap.forEach(c => {
            if(c.val().members && c.val().members[myNick]) {
                const name = c.key.replace('chat_','').replace(myNick,'').replace('_','');
                const icon = document.createElement('div');
                icon.className = 'room-icon';
                icon.innerHTML = `<img src="${getAva(name)}">`;
                icon.onclick = () => openRoom(c.key);
                rDiv.appendChild(icon);
            }
        });
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞
    document.getElementById('sBtn').onclick = () => {
        const inp = document.getElementById('mInp');
        if(activeRoom && (inp.value.trim() || pendingImg)) {
            push(ref(db, `messages/${activeRoom}`), { from: myNick, text: inp.value.trim(), img: pendingImg });
            inp.value = '';
            cancelImg();
        }
    };
</script>
</body>
</html>
